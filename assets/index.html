<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        :root {
            --menu-color: #00000045;
            --lyrics-color: white;
            --spotify-color: #24BB59;
            --spotify-darker-color: #1A7C3C;
            --font-family: "Montserrat", sans-serif;

            --wave-duration: 1.75s;
            --wave-amplitude: 5px;
            --wave-delay-step: 0.03s;
            /* --wave-ease: cubic-bezier(.2,.9,.3,.95); */
            --wave-ease: ease-in-out
        }

        html,
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            overflow: hidden;
            background: #212121;
        }

        #music-player {
            width: 100%;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            backdrop-filter: blur(64px);
        }

        #console {
            position: absolute;
            top: 0;
            left: 0;
        }

        #error {
            padding: 0 2rem 0 2rem;
        }

        #lyrics-content {
            overflow-y: scroll;
            scroll-behavior: smooth;
            height: 80vh;
            text-align: left;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding: 0 2rem 0 2rem;
            max-width: 90vw;
        }

        /* .title {
            display: flex;
            flex-wrap: wrap;
            white-space: pre;
            overflow-wrap: break-word;
            max-width: 100vw;
        } */

        .sub-title {
            display: flex;
            flex-wrap: wrap;
            text-align: right;
            /* opacity: inherit; */
            justify-content: flex-end;
            /* white-space: pre; */
            /* overflow-wrap: break-word; */
            /* max-width: 100vw; */
        }
        
        .actual-lyric {
            display: flex;
            flex-wrap: wrap;
            /* white-space: pre; */
        }

        .word_span {
            display: flex;
            /* width: fit-content; */
            margin-right: 10px;
        }
        
        .actual-lyric .char_span {
            /* display: inline-block; */
            animation: wave var(--wave-duration) var(--wave-ease) infinite;
            /* cicle 1.3s ease-in-out infinite; */
            /* white-space: pre; */
            color: var(--spotify-color);
            text-shadow: 0px 0px 20px var(--spotify-color);
        }

        .actual-lyric .char_span:nth-child(odd),
        .actual-lyric .char_span:nth-child(even) {
            animation-delay: calc(var(--i) * var(--wave-delay-step));
        }

        #lyrics-content::-webkit-scrollbar {
            display: none;
        }

        .text-dark {
            display: flex;
            flex-wrap: wrap;
            opacity: 0.2;
        }

        .text-light {
            display: flex;
            flex-wrap: wrap;
            opacity: 1;
        }

        h2 {
            margin: 10px;
            font-size: 2em;
        }

        h3 {
            font-size: 1.8em;
        }

        #particles-js {
            margin: 0;
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            top: 0;
        }

        @keyframes wave {
            0%   { transform: translateY(0); }
            50%  { transform: translateY(calc(-1 * var(--wave-amplitude))); }
            100% { transform: translateY(0); }
        }

        @keyframes cicle {
            0%   { text-shadow: 0px 0px 10px var(--spotify-darker-color); }
            50%  { text-shadow: 0px 0px 10px var(--spotify-color); }
            100% { text-shadow: 0px 0px 10px var(--spotify-darker-color); }
        }
    </style>
</head>

<body>
    <div id="particles-js"></div>
    <div id="music-player">
        <div id="console"></div>
        <div id="error">
            <h2 class="text-light" style="margin: 0px">Hmmmm</h2>
            <h4 class="text-dark" id="message" style="opacity: 0.5"></h4>
        </div>
        <div id="lyrics">
            <div id="lyrics-content">
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script type="text/javascript">
        let globalLyrics = [];
        let currentIndex = -1;
        let lyricsTimer = null;
        let globalProgress = 0;
        let old_lyrics = '';

        const updateConsole = msg => {
            const el = document.getElementById('console')
            el.innerHTML = `${msg}<br>${el.innerHTML}`
        }
        
        function extractAndConvertToMilliseconds(text) {
            const timePattern = /\[(\d{2}):(\d{2})\.(\d{2})\]/;
            const match = text.match(timePattern);

            if (!match) return -1

            const [, minutes, seconds, centiseconds] = match;
            return (parseInt(minutes, 10) * 60 * 1000) +
                (parseInt(seconds, 10) * 1000) +
                (parseInt(centiseconds, 10) * 10);
        }

        function prepareLyrics(lyrics) {
            const lines = lyrics.split("\n")
            globalLyrics = lines.map(line => {
                const time = extractAndConvertToMilliseconds(line);
                const lyric = time !== -1 ? line.split("]")[1].trim() : line.trim();
                return { time: time === -1 ? null : time, text: lyric || '♪ ♫ ♪' };
            });

            const screen = document.getElementById("lyrics-content")
            screen.innerHTML = ''

            globalLyrics.forEach(({ time, text }) => {
                const element = document.createElement('h2');
                element.id = String(time)
                element.classList.add('title', 'text-dark')
                const match = text.match(/(^\([^)]+\)|\([^)]+\)$)/);
                element.textContent = (match ? text.replace(match[1], '').trim() : text) || '♪ ♫ ♪'
                screen.appendChild(element)

                if (!match) return;
                const subtitle = document.createElement('h3');
                subtitle.id = `${time}-subtitle`
                subtitle.classList.add('sub-title', 'text-dark')
                subtitle.textContent = match[1]
                screen.appendChild(subtitle)
            });
        }

        function setActiveLyric() {
            let index = -1
            globalLyrics.forEach(({ time, text }, idx) => {
                if (!time) return;
                const item = document.getElementById(`${time}`)
                if (globalProgress < time) {
                    item.classList.remove('text-light')
                    item.classList.add('text-dark')
                    const sub = document.getElementById(`${time}-subtitle`)
                    if (!sub) return;

                    sub.classList.add('text-dark')
                    sub.classList.remove('text-light')
                    return;
                }

                item.classList.remove('text-dark')
                item.classList.add('text-light')
                index = idx
                const sub = document.getElementById(`${time}-subtitle`)
                if (!sub) return;

                sub.classList.remove('text-dark')
                sub.classList.add('text-light')
            })
            
            if (index < 0) document.getElementById('lyrics-content').scrollTo({ top: 0, behavior: 'smooth' });
            if (index == currentIndex) return;

            const lyric = globalLyrics[index];
            if (!lyric || !lyric.time) return;

            const prev = document.querySelector('.actual-lyric');
            const node = document.getElementById(lyric.time);
            
            document.getElementById('lyrics-content').scrollTo({
                top: node.offsetTop - (document.getElementById('lyrics-content').clientHeight / 2),
                behavior: 'smooth'
            });

            currentIndex = index;

            if (prev && prev.id === node.id) return;
            
            if (prev) {
                prev.classList.remove('actual-lyric')
                const prev_sub = document.getElementById(`${prev.id}-subtitle`)
                if (prev_sub) prev_sub.classList.remove('actual-lyric')
            }

            node.classList.add('actual-lyric');
            wrapWaveSpansFor(node);
        }

        function scheduleNextLyric() {
            clearTimeout(lyricsTimer);
            if (!globalLyrics.length) {
                lyricsTimer = setTimeout(() => {
                    scheduleNextLyric();
                }, 1000)
                return;
            }

            if (currentIndex + 1 >= globalLyrics.length) {
                lyricsTimer = setTimeout(() => {
                    scheduleNextLyric();
                }, 1000)
                return;
            }

            const nextLyric = globalLyrics[currentIndex + 1];
            if (!nextLyric.time) return;
            const delay = nextLyric.time - globalProgress;

            if (delay <= 0) {
                setActiveLyric();
                scheduleNextLyric();
            } else {
                lyricsTimer = setTimeout(() => {
                    setActiveLyric();
                    scheduleNextLyric();
                }, delay);
            }
        }

        // async function playLyrics(lyrics, milliseconds) {
        //     let cleaned = []
        //     const array = lyrics.split("\n")


        //     array.forEach((items) => {
        //         const found = items.match(/(\[[0-9])\w+/g)
        //         if (found) cleaned.push(items);
        //     })

        //     let contents = ''

        //     cleaned.forEach((items) => {
        //         const id = extractAndConvertToMilliseconds(items)
        //         const lyric = items.split(']')[1].trim();
        //         let subtitle = '';
        //         let subtext = '';
        //         const match = lyric.match(/(^\([^)]+\)|\([^)]+\)$)/);
        //         if (match) {
        //             subtext = match[1]
        //             subtitle = `<h3 id=${id} class="text-dark sub-title">${subtext}</h3>`
        //         }
        //         contents += `<h2 id=${id} class="text-dark">${lyric.replace(subtext, '').trim()}${subtitle}</h2>`
        //     })

        //     document.getElementById('lyrics-content').innerHTML = contents;

        //     let found = 0;
        //     cleaned.forEach((items) => {
        //         const targetMillisecond = extractAndConvertToMilliseconds(items)
        //         if (milliseconds >= targetMillisecond) {
        //             document.getElementById('' + targetMillisecond + '').classList.remove('text-dark')
        //             document.getElementById('' + targetMillisecond + '').classList.add('text-light')
        //             found = targetMillisecond;
        //         }
        //     })

        //     const prev = document.querySelectorAll('.actual-lyric');
        //     prev.forEach(el => {
        //         if (el.id === String(found)) return;
                
        //         el.classList.remove('actual-lyric');
        //     })

        //     const current = document.getElementById(found)
        //     if (!current) return

        //     current.classList.add('actual-lyric');
        //     wrapWaveSpansFor(current);

        //     document.getElementById('lyrics-content').scrollTo({ top: current.offsetTop - (document.getElementById('lyrics-content').clientHeight / 2) })
        // }

        function wrapWaveSpansFor(node) {
            if (!node) return;
            if (node.dataset.waved) return;

            let offset = 0
            const genList = (word, element) => {
                for (let i = 0 + offset; i < word.length + offset; i++) {
                    const ch = word[i - offset];
                    const span = document.createElement('span');
                    span.textContent = ch;
                    span.classList.add('char_span')
                    span.style.setProperty('--i', i);
                    element.appendChild(span);
                }
                offset += word.length
            }

            const text = node.textContent ?? '';
            node.innerHTML = '';
            text.split(' ').forEach(word => {
                const word_span = document.createElement('span');
                word_span.classList.add('word_span');
                genList(word, word_span);
                node.appendChild(word_span)
            })
            const subtitle = document.getElementById(`${node.id}-subtitle`)
            if (subtitle) {
                subtitle.classList.add('actual-lyric')
                offset = 0
                const sub_text = subtitle.textContent ?? '';
                subtitle.innerHTML = '';
                sub_text.split(' ').forEach(word => {
                    const word_span = document.createElement('span');
                    word_span.classList.add('word_span');
                    genList(word, word_span);
                    subtitle.appendChild(word_span)
                })
            }
            node.dataset.waved = '1';
        }


        window.addEventListener("message", (event) => {
            if (event.data.command == 'error') {
                document.getElementById('lyrics').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('message').innerText = event.data.message;
                return;
            }
            document.getElementById('lyrics').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            const { lyrics, milliseconds } = event.data.content;

            if (old_lyrics !== lyrics ) {
                prepareLyrics(lyrics);
                currentIndex = -1;
                old_lyrics = lyrics;
            }
            globalProgress = milliseconds;
            if (currentIndex >= 0 && globalProgress < globalLyrics[currentIndex].time || 0) {
                currentIndex = -1
            }
            scheduleNextLyric(); // TODO: test
        }, false);
        // scheduleNextLyric();


        const partJson = {
            "particles": {
                "number": {
                    "value": 5,
                    "density": {
                        "enable": true,
                        "value_area": 2000
                    }
                },
                "color": {
                    "value": "#1DB954",
                    "opacity": 0.3
                },
                "shape": {
                    "type": "circle",
                    "stroke": {
                        "width": 0,
                        "color": "#000"
                    },
                    "polygon": {
                        "nb_sides": 6
                    },
                    "image": {
                        "src": "img/github.svg",
                        "width": 100,
                        "height": 100
                    }
                },
                "opacity": {
                    "value": 0.3,
                    "random": false,
                    "anim": {
                        "enable": false,
                        "speed": 1,
                        "opacity_min": 0.1,
                        "sync": false
                    }
                },
                "size": {
                    "value": 363.0079151508454,
                    "random": true,
                    "anim": {
                        "enable": true,
                        "speed": 10,
                        "size_min": 40,
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": false,
                    "distance": 200,
                    "color": "#ffffff",
                    "opacity": 1,
                    "width": 2
                },
                "move": {
                    "enable": true,
                    "speed": 8,
                    "direction": "none",
                    "random": false,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false,
                    "attract": {
                        "enable": false,
                        "rotateX": 600,
                        "rotateY": 1200
                    }
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": false,
                        "mode": "grab"
                    },
                    "onclick": {
                        "enable": false,
                        "mode": "push"
                    },
                    "resize": true
                },
                "modes": {
                    "grab": {
                        "distance": 400,
                        "line_linked": {
                            "opacity": 1
                        }
                    },
                    "bubble": {
                        "distance": 400,
                        "size": 40,
                        "duration": 2,
                        "opacity": 8,
                        "speed": 3
                    },
                    "repulse": {
                        "distance": 200,
                        "duration": 0.4
                    },
                    "push": {
                        "particles_nb": 4
                    },
                    "remove": {
                        "particles_nb": 2
                    }
                }
            },
            "retina_detect": true
        }

        var jsonUri = "data:text/plain;base64," + window.btoa(JSON.stringify(partJson));
        particlesJS.load('particles-js', jsonUri, function () {
            console.log('callback - particles-js config loaded');
        });
    </script>
</body>

</html>